### **Анализ проблем и рисков текущей архитектуры**  
*(Связанных с ростом нагрузки и добавлением 5 новых страховых компаний)*  

#### **1. Проблемы синхронного взаимодействия (REST API):**  
- **Задержки ответов:**  
  - Сервис `ins-product-aggregator` синхронно опрашивает все страховые компании (уже 5, станет 10), что увеличит время ответа.  
  - Риск: Timeout'ы при агрегации данных → ошибки в `core-app` и `ins-comp-settlement`.  
- **Низкая отказоустойчивость:**  
  - Если одна из страховых компаний недоступна, весь запрос может завершиться ошибкой.  
- **Дублирование данных:**  
  - Локальные реплики в `core-app` и `ins-comp-settlement` устаревают, требуют частого обновления (раз в 15 мин/сутки).  

#### **2. Проблемы масштабируемости:**  
- **Рост нагрузки на `ins-product-aggregator`:**  
  - При 10 страховых компаниях количество запросов вырастет в 2 раза → возможны перегрузки.  
- **Жёсткая связность:**  
  - `core-app` и `ins-comp-settlement` зависят от синхронных вызовов → при падении `ins-product-aggregator` часть функциональности блокируется.  

#### **3. Проблемы данных и согласованности:**  
- **Неактуальные данные в репликах:**  
  - Тарифы могут измениться в страховых компаниях, но обновляются в `core-app` только раз в 15 минут → клиенты видят устаревшую информацию.  
- **Ошибки в `ins-comp-settlement`:**  
  - Ежедневный запрос к `core-app` за оформленными страховками может потерять данные, если `core-app` недоступен.  

#### **4. Риски при росте числа партнёров:**  
- **Увеличение времени агрегации:**  
  - 10 страховых компаний → дольше сбор данных → выше вероятность сбоев.  
- **Сложность поддержки:**  
  - Добавление новых партнёров требует изменений в `ins-product-aggregator` (жёсткая привязка к REST API).  

---

### **Предлагаемые решения (Event-Driven Architecture)**  

#### **1. Переход на Event-Streaming (Kafka/RabbitMQ):**  
- **Асинхронное обновление данных о продуктах:**  
  - `ins-product-aggregator` публикует события об изменениях тарифов/продуктов в топик Kafka.  
  - `core-app` и `ins-comp-settlement` подписываются на эти события и обновляют локальные кэши в реальном времени.  
  - **Плюсы:**  
    - Нет необходимости в периодических опросах.  
    - Данные всегда актуальны.  
    - Снижение нагрузки на `ins-product-aggregator`.  

#### **2. Использование Transactional Outbox:**  
- **Для гарантированной доставки событий:**  
  - При изменении данных в `ins-product-aggregator` события записываются в Outbox-таблицу PostgreSQL.  
  - Отдельный процесс (CDC, например, Debezium) отправляет события в Kafka.  
  - **Плюсы:**  
    - Сохранение согласованности данных даже при сбоях.  
    - Отказоустойчивость (события не потеряются).  

#### **3. Оптимизация `ins-comp-settlement`:**  
- **Замена ежедневного REST-запроса на события:**  
  - `core-app` публикует событие о каждой оформленной страховке.  
  - `ins-comp-settlement` накапливает эти события и формирует реестр без запросов.  

---

### **Итого:**  
- Устранение синхронных узких мест.  
- Автоматическое обновление данных во всех сервисах.  
- Готовность к масштабированию (10+ страховых компаний).  
- Отказоустойчивость и согласованность данных.  